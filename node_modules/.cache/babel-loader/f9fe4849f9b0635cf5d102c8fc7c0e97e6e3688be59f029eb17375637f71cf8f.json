{"ast":null,"code":"// frontend/src/components/ExamPage.js - ENHANCED VERSION WITH TIMER CONTROL\nimport React,{useEffect,useState,useRef}from\"react\";import*as faceapi from\"face-api.js\";import{useNavigate,useParams}from\"react-router-dom\";import ThemeToggle from\"./ThemeToggle\";import\"./ExamPage.css\";import\"./ProctoringPanel.css\";import{jsx as _jsx,jsxs as _jsxs,Fragment as _Fragment}from\"react/jsx-runtime\";export default function ExamPage(_ref){let{user,onLogout}=_ref;const{examId}=useParams();const videoRef=useRef(null);const[tabSwitchCount,setTabSwitchCount]=useState(0);const[warningShown,setWarningShown]=useState(false);const[timeLeft,setTimeLeft]=useState(null);// Start as null\nconst[timerStarted,setTimerStarted]=useState(false);// NEW\nconst[logs,setLogs]=useState([]);const[paper,setPaper]=useState(null);const[answers,setAnswers]=useState([]);const[currentQ,setCurrentQ]=useState(0);const[registeredDescriptor,setRegisteredDescriptor]=useState(null);const[faceVerificationStatus,setFaceVerificationStatus]=useState(\"loading\");const[verificationFailures,setVerificationFailures]=useState(0);const[modelsLoaded,setModelsLoaded]=useState(false);const[lastVerificationTime,setLastVerificationTime]=useState(Date.now());const multipleFaceActive=useRef(false);const startTimeRef=useRef(null);const isSubmitting=useRef(false);const verificationInterval=useRef(null);const examStartTime=useRef(null);// NEW\nconst multipleFaceViolationCount=useRef(0);// moved here from inside useEffect\nconst navigate=useNavigate();// Stop camera utility\nconst stopCamera=()=>{var _videoRef$current;const stream=(_videoRef$current=videoRef.current)===null||_videoRef$current===void 0?void 0:_videoRef$current.srcObject;if(stream){stream.getTracks().forEach(track=>track.stop());videoRef.current.srcObject=null;console.log(\"ðŸ›‘ Camera stopped\");}};// Load registered face descriptor\nuseEffect(()=>{loadRegisteredFace();},[]);const loadRegisteredFace=async()=>{try{console.log(\"ðŸ”„ Loading registered face descriptor...\");const token=localStorage.getItem(\"token\");const response=await fetch(\"http://localhost:4000/api/auth/face-descriptor\",{headers:{Authorization:\"Bearer \".concat(token)}});if(response.ok){const data=await response.json();if(data.faceDescriptor&&Array.isArray(data.faceDescriptor)&&data.faceDescriptor.length===128){setRegisteredDescriptor(new Float32Array(data.faceDescriptor));setFaceVerificationStatus(\"ready\");console.log(\"âœ… Face verification system ready!\");}else{alert(\"Invalid face descriptor. Please re-register your face.\");navigate(\"/face-registration\");}}else{alert(\"âš ï¸ Please register your face before taking exams!\");navigate(\"/face-registration\");}}catch(error){console.error(\"âŒ Error loading face descriptor:\",error);setFaceVerificationStatus(\"error\");alert(\"Failed to load face verification. Please try again.\");}};// Load exam paper & models\nuseEffect(()=>{const loadModelsAndExam=async()=>{try{var _data$questions;console.log(\"ðŸ”„ Loading face detection models...\");const MODEL_URL=process.env.PUBLIC_URL+\"/models\";await Promise.all([faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)]);setModelsLoaded(true);console.log(\"âœ… Models loaded\");const res=await fetch(\"http://localhost:4000/api/exam/paper/\".concat(examId),{headers:{Authorization:\"Bearer \".concat(localStorage.getItem(\"token\"))}});if(!res.ok)throw new Error(\"Server error: \".concat(res.status));const data=await res.json();if(!(data!==null&&data!==void 0&&(_data$questions=data.questions)!==null&&_data$questions!==void 0&&_data$questions.length))throw new Error(\"No questions in exam\");setPaper(data);setAnswers(new Array(data.questions.length).fill(null));// SET TIMER BUT DON'T START IT YET\nsetTimeLeft((data.durationMins||10)*60);const stream=await navigator.mediaDevices.getUserMedia({video:{width:640,height:480}});if(videoRef.current){videoRef.current.srcObject=stream;// START TIMER WHEN VIDEO IS READY\nvideoRef.current.onloadedmetadata=()=>{console.log(\"ðŸ“¹ Camera ready - Starting timer NOW\");examStartTime.current=Date.now();setTimerStarted(true);};}}catch(err){console.error(\"âŒ Setup failed:\",err);alert(\"Failed to load exam: \".concat(err.message));navigate(\"/student/dashboard\");}};loadModelsAndExam();return()=>{stopCamera();if(verificationInterval.current){clearInterval(verificationInterval.current);}};},[examId,navigate]);// TIMER COUNTDOWN - Only runs when timerStarted is true\nuseEffect(()=>{if(!timerStarted||timeLeft===null)return;if(timeLeft<=0){alert(\"â° Time's up! Auto-submitting your exam...\");handleSubmit();return;}const timer=setTimeout(()=>{setTimeLeft(prev=>prev-1);},1000);return()=>clearTimeout(timer);},[timeLeft,timerStarted]);// Face verification monitoring\nuseEffect(()=>{if(!paper||!registeredDescriptor||!modelsLoaded||!timerStarted)return;verificationInterval.current=setInterval(async()=>{await verifyFaceIdentity();},5000);// Initial verification\nsetTimeout(()=>verifyFaceIdentity(),2000);return()=>{if(verificationInterval.current){clearInterval(verificationInterval.current);}};},[paper,registeredDescriptor,modelsLoaded,timerStarted]);const verifyFaceIdentity=async()=>{if(!videoRef.current||!registeredDescriptor)return;if(!videoRef.current.readyState||videoRef.current.readyState<2){console.log(\"Video not ready for face detection, skipping verification\");return;// Video not ready yet\n}try{// Multiple attempts for more reliable verification\nconst attempts=3;let validDetections=[];for(let i=0;i<attempts;i++){// Check video is still valid before each attempt\nif(!videoRef.current||!videoRef.current.readyState||videoRef.current.readyState<2){console.log(\"Video not ready during detection attempt\",i);break;}const detection=await faceapi.detectSingleFace(videoRef.current,new faceapi.TinyFaceDetectorOptions({inputSize:224,scoreThreshold:0.5})).withFaceLandmarks().withFaceDescriptor();if(detection){validDetections.push(detection);}// Small delay between attempts\nif(i<attempts-1){await new Promise(resolve=>setTimeout(resolve,200));}}const currentTime=Date.now();const timeSinceLastVerification=currentTime-lastVerificationTime;if(validDetections.length===0){setLogs(prev=>[...prev,\"\\u26A0\\uFE0F No face detected at \".concat(new Date().toLocaleTimeString())]);setFaceVerificationStatus(\"warning\");// Log to backend\nawait fetch(\"http://localhost:4000/api/exam/verify-face\",{method:\"POST\",headers:{\"Content-Type\":\"application/json\",Authorization:\"Bearer \".concat(localStorage.getItem(\"token\"))},body:JSON.stringify({examId,verificationStatus:\"no_face\",details:\"No face detected during verification at \".concat(new Date().toLocaleTimeString())})});return;}// Calculate average distance for more stable verification\nlet totalDistance=0;let bestDistance=Infinity;validDetections.forEach(detection=>{const distance=faceapi.euclideanDistance(registeredDescriptor,detection.descriptor);totalDistance+=distance;if(distance<bestDistance){bestDistance=distance;}});const avgDistance=totalDistance/validDetections.length;const similarity=Math.max(0,(1-avgDistance)*100);// Stricter threshold for continuous verification\nconst VERIFICATION_THRESHOLD=0.45;const isMatch=avgDistance<VERIFICATION_THRESHOLD;console.log(\"\\uD83D\\uDD10 Verification: Detections=\".concat(validDetections.length,\"/\").concat(attempts,\", AvgDistance=\").concat(avgDistance.toFixed(3),\", BestDistance=\").concat(bestDistance.toFixed(3),\", Similarity=\").concat(similarity.toFixed(1),\"%, Match=\").concat(isMatch));if(isMatch){setFaceVerificationStatus(\"verified\");setVerificationFailures(0);// Only log successful verifications occasionally to avoid cluttering the log\nif(Math.random()<0.3){setLogs(prev=>[...prev,\"\\u2705 Identity verified at \".concat(new Date().toLocaleTimeString(),\" (\").concat(similarity.toFixed(1),\"%)\")]);}// Log to backend (less frequently)\nif(Math.random()<0.2){await fetch(\"http://localhost:4000/api/exam/verify-face\",{method:\"POST\",headers:{\"Content-Type\":\"application/json\",Authorization:\"Bearer \".concat(localStorage.getItem(\"token\"))},body:JSON.stringify({examId,verificationStatus:\"verified\",confidence:similarity,details:\"Identity verified for \".concat(user.name)})});}}else{const newCount=verificationFailures+1;setVerificationFailures(newCount);setFaceVerificationStatus(\"failed\");setLogs(prev=>[...prev,\"\\u274C Identity mismatch at \".concat(new Date().toLocaleTimeString(),\" (\").concat(similarity.toFixed(1),\"%) - Attempt \").concat(newCount,\"/3\")]);// Log the identity verification failure (no alert message)\n// The failure will be recorded in proctoring logs for admin review\n// Log to backend\nawait fetch(\"http://localhost:4000/api/exam/verify-face\",{method:\"POST\",headers:{\"Content-Type\":\"application/json\",Authorization:\"Bearer \".concat(localStorage.getItem(\"token\"))},body:JSON.stringify({examId,verificationStatus:\"failed\",confidence:similarity,details:\"Identity mismatch detected - Expected: \".concat(user.name,\", Attempt: \").concat(newCount,\"/3\")})});if(newCount>=3){// Auto-submit without alert message\n// Maximum verification failures reached, exam will be auto-submitted\nhandleSubmit();}}setLastVerificationTime(currentTime);}catch(error){console.error(\"Verification error:\",error);setLogs(prev=>[...prev,\"\\u26A0\\uFE0F Verification error at \".concat(new Date().toLocaleTimeString())]);}};// Tab switching detection with duration tracking\nuseEffect(()=>{let tabSwitchStartTime=null;const handleVisibilityChange=()=>{if(!timerStarted)return;if(document.hidden){// Tab switched away\ntabSwitchStartTime=new Date();}else if(tabSwitchStartTime){// Tab switched back\nconst endTime=new Date();const duration=Math.round((endTime-tabSwitchStartTime)/1000);const newCount=tabSwitchCount+1;setTabSwitchCount(newCount);setLogs(prev=>[...prev,\"\\u26A0\\uFE0F Tab switch #\".concat(newCount,\" at \").concat(tabSwitchStartTime?tabSwitchStartTime.toLocaleTimeString():new Date().toLocaleTimeString(),\" (Duration: \").concat(duration,\"s)\")]);// Log to backend\ntry{const token=localStorage.getItem(\"token\");fetch(\"http://localhost:4000/api/exam/log-violation\",{method:\"POST\",headers:{\"Content-Type\":\"application/json\",Authorization:\"Bearer \".concat(token)},body:JSON.stringify({examId,violationType:\"tab_switch\",details:\"Tab switch #\".concat(newCount,\" (Duration: \").concat(duration,\"s)\"),timestamp:new Date().toISOString()})});}catch(error){console.error(\"Error logging tab switch:\",error);}tabSwitchStartTime=null;}};document.addEventListener(\"visibilitychange\",handleVisibilityChange);return()=>document.removeEventListener(\"visibilitychange\",handleVisibilityChange);},[tabSwitchCount,timerStarted,examId]);// Tab warning logic (without alert messages)\nuseEffect(()=>{if(tabSwitchCount===1&&!warningShown){// First tab switch - log without alert\nsetWarningShown(true);}else if(tabSwitchCount===2){// Second tab switch - log without alert\n}else if(tabSwitchCount>=3){// Too many tab switches - auto-submit without alert\n// Log critical violation\ntry{const token=localStorage.getItem(\"token\");fetch(\"http://localhost:4000/api/exam/log-violation\",{method:\"POST\",headers:{\"Content-Type\":\"application/json\",Authorization:\"Bearer \".concat(token)},body:JSON.stringify({examId,violationType:\"critical_tab_switch\",details:\"Critical violation: \".concat(tabSwitchCount,\" tab switches detected. Auto-submitting exam.\"),timestamp:new Date().toISOString(),severity:\"critical\"})});}catch(error){console.error(\"Error logging critical violation:\",error);}handleSubmit();}},[tabSwitchCount,warningShown,examId]);// Enhanced multiple face detection with violation logging\nuseEffect(()=>{if(!paper||!timerStarted)return;const VIOLATION_THRESHOLD=3;// Auto-submit after 3 violations\nconst interval=setInterval(async()=>{if(!videoRef.current)return;// Check if video is ready for processing\nif(!videoRef.current.readyState||videoRef.current.readyState<2){console.log(\"Video not ready for multiple face detection, skipping check\");return;}try{const detections=await faceapi.detectAllFaces(videoRef.current,new faceapi.TinyFaceDetectorOptions({scoreThreshold:0.6// Higher threshold for more accurate detection\n}));if(detections.length>1){if(!multipleFaceActive.current){multipleFaceActive.current=true;startTimeRef.current=new Date();// Increment violation count\nmultipleFaceViolationCount.current++;// Log to UI\nsetLogs(prev=>[...prev,\"\\uD83D\\uDC65 VIOLATION: Multiple faces detected (\".concat(detections.length,\" people) at \").concat(startTimeRef.current?startTimeRef.current.toLocaleTimeString():new Date().toLocaleTimeString(),\" - #\").concat(multipleFaceViolationCount.current)]);// Log to backend\ntry{const token=localStorage.getItem(\"token\");fetch(\"http://localhost:4000/api/exam/log-violation\",{method:\"POST\",headers:{\"Content-Type\":\"application/json\",Authorization:\"Bearer \".concat(token)},body:JSON.stringify({examId,violationType:\"multiple_faces\",details:\"Multiple faces detected (\".concat(detections.length,\" people)\"),timestamp:new Date().toISOString(),faceCount:detections.length,violationNumber:multipleFaceViolationCount.current})});}catch(error){console.error(\"Error logging multiple face violation:\",error);}// Log violation without alert message\n// Multiple face detection will be recorded in proctoring logs for admin review\n// Auto-submit if threshold reached (without alert)\nif(multipleFaceViolationCount.current>=VIOLATION_THRESHOLD){// Maximum violations reached, auto-submit exam\nhandleSubmit();}}}else if(multipleFaceActive.current){multipleFaceActive.current=false;const endTime=new Date();const duration=Math.round((endTime-startTimeRef.current)/1000);setLogs(prev=>[...prev,\"\\u2705 Multiple faces cleared at \".concat(endTime.toLocaleTimeString(),\" (Duration: \").concat(duration,\"s)\")]);// Log resolution to backend\ntry{const token=localStorage.getItem(\"token\");fetch(\"http://localhost:4000/api/exam/log-violation\",{method:\"POST\",headers:{\"Content-Type\":\"application/json\",Authorization:\"Bearer \".concat(token)},body:JSON.stringify({examId,violationType:\"multiple_faces_resolved\",details:\"Multiple faces violation resolved after \".concat(duration,\" seconds\"),timestamp:new Date().toISOString(),duration:duration})});}catch(error){console.error(\"Error logging violation resolution:\",error);}}}catch(err){console.error(\"Face detection error:\",err);}},3000);return()=>clearInterval(interval);},[paper,timerStarted,examId]);// Define formatTime and handleSubmit before they're used\nconst formatTime=seconds=>{if(seconds===null)return\"Loading...\";const min=Math.floor(seconds/60);const sec=seconds%60;return\"\".concat(min,\":\").concat(sec<10?\"0\":\"\").concat(sec);};const handleAnswerChange=(index,value)=>{const newAnswers=[...answers];newAnswers[index]=value;setAnswers(newAnswers);};// Submit handler\nconst handleSubmit=async()=>{if(isSubmitting.current)return;if(!paper)return alert(\"Exam not loaded!\");const isAutoSubmit=tabSwitchCount>=3||timeLeft<=0||verificationFailures>=3;if(!isAutoSubmit){if(!window.confirm(\"Are you sure you want to submit?\\n\\n\"+\"Time Remaining: \".concat(formatTime(timeLeft),\"\\n\")+\"Questions Answered: \".concat(answers.filter(a=>a!==null).length,\"/\").concat(answers.length,\"\\n\\n\")+\"You cannot change your answers after submission.\")){return;}}isSubmitting.current=true;try{console.log(\"Submitting exam answers:\",{examId,answersCount:answers.length,tabSwitches:tabSwitchCount,verificationFailures});const token=localStorage.getItem(\"token\");if(!token){throw new Error(\"Authentication token not found\");}const response=await fetch(\"http://localhost:4000/api/exam/submit\",{method:\"POST\",headers:{\"Content-Type\":\"application/json\",Authorization:\"Bearer \".concat(token)},body:JSON.stringify({userId:user===null||user===void 0?void 0:user._id,examId,answers,tabSwitches:[{timestamp:new Date().toISOString(),timeInExam:formatTime(paper.durationMins*60-timeLeft),warningMessage:\"\".concat(tabSwitchCount,\" tab switches detected during exam\")}],verificationFailures,timeSpent:examStartTime.current?Math.floor((Date.now()-examStartTime.current)/1000):null})});const responseText=await response.text();console.log(\"Submit response:\",response.status,responseText);if(!response.ok){throw new Error(\"Submit failed: \".concat(response.status,\" - \").concat(responseText));}let data;try{data=JSON.parse(responseText);}catch(e){throw new Error(\"Invalid JSON response: \".concat(responseText));}if(data.submissionId){console.log(\"Submission successful, ID:\",data.submissionId);stopCamera();navigate(\"/result/\".concat(data.submissionId));}else{throw new Error(\"No submission ID returned in response\");}}catch(err){console.error(\"Submit error:\",err);alert(\"\\u274C Failed to submit exam: \".concat(err.message,\". Please try again.\"));isSubmitting.current=false;}};if(!paper||!paper.questions){return/*#__PURE__*/_jsxs(\"div\",{className:\"exam-loading\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"loading-spinner\"}),/*#__PURE__*/_jsx(\"h3\",{children:\"Loading exam...\"}),/*#__PURE__*/_jsx(\"p\",{children:\"Please wait while we prepare your exam environment...\"})]});}const question=paper.questions[currentQ];return/*#__PURE__*/_jsxs(\"div\",{className:\"exam-page\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"theme-toggle-container\",children:/*#__PURE__*/_jsx(ThemeToggle,{})}),/*#__PURE__*/_jsx(\"div\",{className:\"timer-status-banner \".concat(timerStarted?'active':'waiting'),children:timerStarted?/*#__PURE__*/_jsxs(_Fragment,{children:[\"\\u23F1\\uFE0F \",/*#__PURE__*/_jsx(\"strong\",{children:\"Timer Started:\"}),\" Exam in progress\"]}):/*#__PURE__*/_jsxs(_Fragment,{children:[\"\\u23F3 \",/*#__PURE__*/_jsx(\"strong\",{children:\"Initializing:\"}),\" Timer will start when camera is ready...\"]})}),/*#__PURE__*/_jsx(\"div\",{className:\"verification-banner \".concat(faceVerificationStatus),children:/*#__PURE__*/_jsxs(\"div\",{className:\"verification-content\",children:[faceVerificationStatus===\"verified\"&&/*#__PURE__*/_jsxs(_Fragment,{children:[\"\\u2705 \",/*#__PURE__*/_jsx(\"strong\",{children:\"Identity Verified:\"}),\" \",user.name]}),faceVerificationStatus===\"failed\"&&/*#__PURE__*/_jsxs(_Fragment,{children:[\"\\u274C \",/*#__PURE__*/_jsx(\"strong\",{children:\"Verification Failed:\"}),\" \",verificationFailures,\"/3 attempts\"]}),faceVerificationStatus===\"warning\"&&/*#__PURE__*/_jsxs(_Fragment,{children:[\"\\u26A0\\uFE0F \",/*#__PURE__*/_jsx(\"strong\",{children:\"Warning:\"}),\" Face not detected\"]}),faceVerificationStatus===\"loading\"&&/*#__PURE__*/_jsxs(_Fragment,{children:[\"\\uD83D\\uDD04 \",/*#__PURE__*/_jsx(\"strong\",{children:\"Loading:\"}),\" Preparing verification system...\"]}),faceVerificationStatus===\"ready\"&&/*#__PURE__*/_jsxs(_Fragment,{children:[\"\\uD83D\\uDFE2 \",/*#__PURE__*/_jsx(\"strong\",{children:\"Ready:\"}),\" Verification system active\"]})]})}),/*#__PURE__*/_jsxs(\"div\",{className:\"proctoring-violations-summary\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"violation-metric\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"violation-label\",children:\"Identity Verification:\"}),/*#__PURE__*/_jsx(\"span\",{className:\"violation-value \".concat(verificationFailures>0?'warning':'good'),children:verificationFailures>0?\"\".concat(verificationFailures,\"/3 Failures\"):'Good'})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"violation-metric\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"violation-label\",children:\"Tab Switching:\"}),/*#__PURE__*/_jsx(\"span\",{className:\"violation-value \".concat(tabSwitchCount>0?'warning':'good'),children:tabSwitchCount>0?\"\".concat(tabSwitchCount,\"/3 Switches\"):'None'})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"violation-metric\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"violation-label\",children:\"Multiple Faces:\"}),/*#__PURE__*/_jsx(\"span\",{className:\"violation-value \".concat(multipleFaceActive.current?'critical':'good'),children:multipleFaceActive.current?'DETECTED!':'None'})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"logs-container\",children:[/*#__PURE__*/_jsx(\"h4\",{children:\"Proctoring Logs\"}),/*#__PURE__*/_jsx(\"div\",{className:\"logs\",children:logs.slice(-8).reverse().map((log,index)=>/*#__PURE__*/_jsx(\"div\",{className:\"log-entry \".concat(log.includes(\"VIOLATION\")?\"violation-log\":log.includes(\"âš ï¸\")?\"warning-log\":log.includes(\"âœ…\")?\"success-log\":\"\"),children:log},index))})]})]}),/*#__PURE__*/_jsx(\"button\",{onClick:()=>{if(window.confirm(\"Exit exam? Your progress will be lost!\")){stopCamera();navigate(\"/student/dashboard\");}},className:\"exam-back-btn\",children:\"\\u2190 Exit Exam\"}),/*#__PURE__*/_jsxs(\"div\",{className:\"exam-header\",children:[/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"h2\",{children:paper.title}),/*#__PURE__*/_jsxs(\"p\",{children:[\"Student: \",/*#__PURE__*/_jsx(\"strong\",{children:user.name})]})]}),/*#__PURE__*/_jsx(\"div\",{className:\"timer\",children:timerStarted?/*#__PURE__*/_jsxs(_Fragment,{children:[\"\\u23F1\\uFE0F Time: \",formatTime(timeLeft)]}):/*#__PURE__*/_jsx(_Fragment,{children:\"\\u23F3 Starting...\"})})]}),tabSwitchCount>0&&/*#__PURE__*/_jsxs(\"div\",{className:\"exam-tab-warning\",children:[\"\\u26A0\\uFE0F \",/*#__PURE__*/_jsxs(\"strong\",{children:[\"Tab Switches Detected: \",tabSwitchCount,\"/3\"]}),tabSwitchCount>=2&&\" - One more will auto-submit!\"]}),/*#__PURE__*/_jsxs(\"div\",{className:\"exam-body\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"exam-main-content\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"exam-progress\",children:[\"Question \",currentQ+1,\" of \",paper.questions.length]}),/*#__PURE__*/_jsxs(\"div\",{className:\"exam-question\",children:[/*#__PURE__*/_jsxs(\"h3\",{children:[\"Q\",currentQ+1,\": \",question.text]}),question.imageUrl&&/*#__PURE__*/_jsx(\"div\",{className:\"exam-question-image\",children:/*#__PURE__*/_jsx(\"img\",{src:question.imageUrl,alt:\"Question\",onError:e=>{console.log(\"Image failed to load:\",question.imageUrl);e.target.onerror=null;e.target.src=\"https://via.placeholder.com/400x200?text=Image+Not+Available\";}})}),console.log(\"Question data:\",question),/*#__PURE__*/_jsx(\"div\",{className:\"exam-options\",children:question.options.map((opt,idx)=>/*#__PURE__*/_jsxs(\"label\",{className:\"exam-option-label \".concat(answers[currentQ]===opt?\"selected\":\"\"),children:[/*#__PURE__*/_jsx(\"input\",{type:\"radio\",name:\"q\".concat(currentQ),checked:answers[currentQ]===opt,onChange:()=>handleAnswerChange(currentQ,opt)}),opt]},idx))})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"exam-nav-buttons\",children:[currentQ>0&&/*#__PURE__*/_jsx(\"button\",{onClick:()=>setCurrentQ(currentQ-1),className:\"exam-prev-btn\",children:\"\\u2B05\\uFE0F Previous\"}),currentQ<paper.questions.length-1?/*#__PURE__*/_jsx(\"button\",{onClick:()=>setCurrentQ(currentQ+1),className:\"exam-next-btn\",children:\"Next \\u27A1\\uFE0F\"}):/*#__PURE__*/_jsx(\"button\",{onClick:handleSubmit,className:\"exam-submit-btn\",disabled:isSubmitting.current,children:isSubmitting.current?\"â³ Submitting...\":\"ðŸš€ Submit Exam\"})]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"exam-sidebar\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"exam-camera-preview\",children:[/*#__PURE__*/_jsx(\"h4\",{children:\"\\uD83D\\uDCF7 Live Monitoring\"}),/*#__PURE__*/_jsx(\"video\",{ref:videoRef,autoPlay:true,muted:true,playsInline:true,style:{width:\"100%\",maxWidth:\"300px\",borderRadius:\"12px\"}}),/*#__PURE__*/_jsxs(\"div\",{className:\"verification-status\",children:[faceVerificationStatus===\"verified\"&&/*#__PURE__*/_jsx(\"span\",{className:\"status-verified\",children:\"\\u2705 Verified\"}),faceVerificationStatus===\"failed\"&&/*#__PURE__*/_jsxs(\"span\",{className:\"status-warning\",children:[\"\\u274C Failed (\",verificationFailures,\"/3)\"]})]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"exam-face-logs\",children:[/*#__PURE__*/_jsx(\"h4\",{children:\"\\uD83D\\uDCCB Activity Log\"}),logs.length>0?/*#__PURE__*/_jsx(\"ul\",{children:logs.slice(-10).reverse().map((log,i)=>/*#__PURE__*/_jsx(\"li\",{children:log},i))}):/*#__PURE__*/_jsx(\"p\",{children:\"\\u2705 No issues detected\"})]})]})]})]});}","map":{"version":3,"names":["React","useEffect","useState","useRef","faceapi","useNavigate","useParams","ThemeToggle","jsx","_jsx","jsxs","_jsxs","Fragment","_Fragment","ExamPage","_ref","user","onLogout","examId","videoRef","tabSwitchCount","setTabSwitchCount","warningShown","setWarningShown","timeLeft","setTimeLeft","timerStarted","setTimerStarted","logs","setLogs","paper","setPaper","answers","setAnswers","currentQ","setCurrentQ","registeredDescriptor","setRegisteredDescriptor","faceVerificationStatus","setFaceVerificationStatus","verificationFailures","setVerificationFailures","modelsLoaded","setModelsLoaded","lastVerificationTime","setLastVerificationTime","Date","now","multipleFaceActive","startTimeRef","isSubmitting","verificationInterval","examStartTime","multipleFaceViolationCount","navigate","stopCamera","_videoRef$current","stream","current","srcObject","getTracks","forEach","track","stop","console","log","loadRegisteredFace","token","localStorage","getItem","response","fetch","headers","Authorization","concat","ok","data","json","faceDescriptor","Array","isArray","length","Float32Array","alert","error","loadModelsAndExam","_data$questions","MODEL_URL","process","env","PUBLIC_URL","Promise","all","nets","tinyFaceDetector","loadFromUri","faceLandmark68Net","faceRecognitionNet","res","Error","status","questions","fill","durationMins","navigator","mediaDevices","getUserMedia","video","width","height","onloadedmetadata","err","message","clearInterval","handleSubmit","timer","setTimeout","prev","clearTimeout","setInterval","verifyFaceIdentity","readyState","attempts","validDetections","i","detection","detectSingleFace","TinyFaceDetectorOptions","inputSize","scoreThreshold","withFaceLandmarks","withFaceDescriptor","push","resolve","currentTime","timeSinceLastVerification","toLocaleTimeString","method","body","JSON","stringify","verificationStatus","details","totalDistance","bestDistance","Infinity","distance","euclideanDistance","descriptor","avgDistance","similarity","Math","max","VERIFICATION_THRESHOLD","isMatch","toFixed","random","confidence","name","newCount","tabSwitchStartTime","handleVisibilityChange","document","hidden","endTime","duration","round","violationType","timestamp","toISOString","addEventListener","removeEventListener","severity","VIOLATION_THRESHOLD","interval","detections","detectAllFaces","faceCount","violationNumber","formatTime","seconds","min","floor","sec","handleAnswerChange","index","value","newAnswers","isAutoSubmit","window","confirm","filter","a","answersCount","tabSwitches","userId","_id","timeInExam","warningMessage","timeSpent","responseText","text","parse","e","submissionId","className","children","question","slice","reverse","map","includes","onClick","title","imageUrl","src","alt","onError","target","onerror","options","opt","idx","type","checked","onChange","disabled","ref","autoPlay","muted","playsInline","style","maxWidth","borderRadius"],"sources":["C:/Online Exam Proctoring System/frontend/src/components/ExamPage.js"],"sourcesContent":["// frontend/src/components/ExamPage.js - ENHANCED VERSION WITH TIMER CONTROL\r\nimport React, { useEffect, useState, useRef } from \"react\";\r\nimport * as faceapi from \"face-api.js\";\r\nimport { useNavigate, useParams } from \"react-router-dom\";\r\nimport ThemeToggle from \"./ThemeToggle\";\r\nimport \"./ExamPage.css\";\r\nimport \"./ProctoringPanel.css\";\r\n\r\nexport default function ExamPage({ user, onLogout }) {\r\n  const { examId } = useParams();\r\n  const videoRef = useRef(null);\r\n  const [tabSwitchCount, setTabSwitchCount] = useState(0);\r\n  const [warningShown, setWarningShown] = useState(false);\r\n  const [timeLeft, setTimeLeft] = useState(null); // Start as null\r\n  const [timerStarted, setTimerStarted] = useState(false); // NEW\r\n  const [logs, setLogs] = useState([]);\r\n  const [paper, setPaper] = useState(null);\r\n  const [answers, setAnswers] = useState([]);\r\n  const [currentQ, setCurrentQ] = useState(0);\r\n\r\n  const [registeredDescriptor, setRegisteredDescriptor] = useState(null);\r\n  const [faceVerificationStatus, setFaceVerificationStatus] = useState(\"loading\");\r\n  const [verificationFailures, setVerificationFailures] = useState(0);\r\n  const [modelsLoaded, setModelsLoaded] = useState(false);\r\n  const [lastVerificationTime, setLastVerificationTime] = useState(Date.now());\r\n\r\n  const multipleFaceActive = useRef(false);\r\n  const startTimeRef = useRef(null);\r\n  const isSubmitting = useRef(false);\r\n  const verificationInterval = useRef(null);\r\n  const examStartTime = useRef(null); // NEW\r\n  const multipleFaceViolationCount = useRef(0); // moved here from inside useEffect\r\n\r\n  const navigate = useNavigate();\r\n\r\n  // Stop camera utility\r\n  const stopCamera = () => {\r\n    const stream = videoRef.current?.srcObject;\r\n    if (stream) {\r\n      stream.getTracks().forEach(track => track.stop());\r\n      videoRef.current.srcObject = null;\r\n      console.log(\"ðŸ›‘ Camera stopped\");\r\n    }\r\n  };\r\n\r\n  // Load registered face descriptor\r\n  useEffect(() => {\r\n    loadRegisteredFace();\r\n  }, []);\r\n\r\n  const loadRegisteredFace = async () => {\r\n    try {\r\n      console.log(\"ðŸ”„ Loading registered face descriptor...\");\r\n      const token = localStorage.getItem(\"token\");\r\n      const response = await fetch(\"http://localhost:4000/api/auth/face-descriptor\", {\r\n        headers: { Authorization: `Bearer ${token}` },\r\n      });\r\n\r\n      if (response.ok) {\r\n        const data = await response.json();\r\n        if (data.faceDescriptor && Array.isArray(data.faceDescriptor) && data.faceDescriptor.length === 128) {\r\n          setRegisteredDescriptor(new Float32Array(data.faceDescriptor));\r\n          setFaceVerificationStatus(\"ready\");\r\n          console.log(\"âœ… Face verification system ready!\");\r\n        } else {\r\n          alert(\"Invalid face descriptor. Please re-register your face.\");\r\n          navigate(\"/face-registration\");\r\n        }\r\n      } else {\r\n        alert(\"âš ï¸ Please register your face before taking exams!\");\r\n        navigate(\"/face-registration\");\r\n      }\r\n    } catch (error) {\r\n      console.error(\"âŒ Error loading face descriptor:\", error);\r\n      setFaceVerificationStatus(\"error\");\r\n      alert(\"Failed to load face verification. Please try again.\");\r\n    }\r\n  };\r\n\r\n  // Load exam paper & models\r\n  useEffect(() => {\r\n    const loadModelsAndExam = async () => {\r\n      try {\r\n        console.log(\"ðŸ”„ Loading face detection models...\");\r\n        const MODEL_URL = process.env.PUBLIC_URL + \"/models\";\r\n\r\n        await Promise.all([\r\n          faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),\r\n          faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),\r\n          faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL),\r\n        ]);\r\n\r\n        setModelsLoaded(true);\r\n        console.log(\"âœ… Models loaded\");\r\n\r\n        const res = await fetch(`http://localhost:4000/api/exam/paper/${examId}`, {\r\n          headers: { Authorization: `Bearer ${localStorage.getItem(\"token\")}` },\r\n        });\r\n\r\n        if (!res.ok) throw new Error(`Server error: ${res.status}`);\r\n        const data = await res.json();\r\n\r\n        if (!data?.questions?.length) throw new Error(\"No questions in exam\");\r\n\r\n        setPaper(data);\r\n        setAnswers(new Array(data.questions.length).fill(null));\r\n        \r\n        // SET TIMER BUT DON'T START IT YET\r\n        setTimeLeft((data.durationMins || 10) * 60);\r\n\r\n        const stream = await navigator.mediaDevices.getUserMedia({\r\n          video: { width: 640, height: 480 },\r\n        });\r\n        if (videoRef.current) {\r\n          videoRef.current.srcObject = stream;\r\n          \r\n          // START TIMER WHEN VIDEO IS READY\r\n          videoRef.current.onloadedmetadata = () => {\r\n            console.log(\"ðŸ“¹ Camera ready - Starting timer NOW\");\r\n            examStartTime.current = Date.now();\r\n            setTimerStarted(true);\r\n          };\r\n        }\r\n      } catch (err) {\r\n        console.error(\"âŒ Setup failed:\", err);\r\n        alert(`Failed to load exam: ${err.message}`);\r\n        navigate(\"/student/dashboard\");\r\n      }\r\n    };\r\n\r\n    loadModelsAndExam();\r\n    return () => {\r\n      stopCamera();\r\n      if (verificationInterval.current) {\r\n        clearInterval(verificationInterval.current);\r\n      }\r\n    };\r\n  }, [examId, navigate]);\r\n\r\n  // TIMER COUNTDOWN - Only runs when timerStarted is true\r\n  useEffect(() => {\r\n    if (!timerStarted || timeLeft === null) return;\r\n\r\n    if (timeLeft <= 0) {\r\n      alert(\"â° Time's up! Auto-submitting your exam...\");\r\n      handleSubmit();\r\n      return;\r\n    }\r\n\r\n    const timer = setTimeout(() => {\r\n      setTimeLeft(prev => prev - 1);\r\n    }, 1000);\r\n\r\n    return () => clearTimeout(timer);\r\n  }, [timeLeft, timerStarted]);\r\n\r\n  // Face verification monitoring\r\n  useEffect(() => {\r\n    if (!paper || !registeredDescriptor || !modelsLoaded || !timerStarted) return;\r\n\r\n    verificationInterval.current = setInterval(async () => {\r\n      await verifyFaceIdentity();\r\n    }, 5000);\r\n\r\n    // Initial verification\r\n    setTimeout(() => verifyFaceIdentity(), 2000);\r\n\r\n    return () => {\r\n      if (verificationInterval.current) {\r\n        clearInterval(verificationInterval.current);\r\n      }\r\n    };\r\n  }, [paper, registeredDescriptor, modelsLoaded, timerStarted]);\r\n\r\n  const verifyFaceIdentity = async () => {\r\n    if (!videoRef.current || !registeredDescriptor) return;\r\n    if (!videoRef.current.readyState || videoRef.current.readyState < 2) {\r\n      console.log(\"Video not ready for face detection, skipping verification\");\r\n      return; // Video not ready yet\r\n    }\r\n\r\n    try {\r\n      // Multiple attempts for more reliable verification\r\n      const attempts = 3;\r\n      let validDetections = [];\r\n      \r\n      for (let i = 0; i < attempts; i++) {\r\n        // Check video is still valid before each attempt\r\n        if (!videoRef.current || !videoRef.current.readyState || videoRef.current.readyState < 2) {\r\n          console.log(\"Video not ready during detection attempt\", i);\r\n          break;\r\n        }\r\n        \r\n        const detection = await faceapi\r\n          .detectSingleFace(videoRef.current, new faceapi.TinyFaceDetectorOptions({ \r\n            inputSize: 224,\r\n            scoreThreshold: 0.5\r\n          }))\r\n          .withFaceLandmarks()\r\n          .withFaceDescriptor();\r\n          \r\n        if (detection) {\r\n          validDetections.push(detection);\r\n        }\r\n        \r\n        // Small delay between attempts\r\n        if (i < attempts - 1) {\r\n          await new Promise(resolve => setTimeout(resolve, 200));\r\n        }\r\n      }\r\n\r\n      const currentTime = Date.now();\r\n      const timeSinceLastVerification = currentTime - lastVerificationTime;\r\n\r\n      if (validDetections.length === 0) {\r\n        setLogs(prev => [...prev, `âš ï¸ No face detected at ${new Date().toLocaleTimeString()}`]);\r\n        setFaceVerificationStatus(\"warning\");\r\n        \r\n        // Log to backend\r\n        await fetch(\"http://localhost:4000/api/exam/verify-face\", {\r\n          method: \"POST\",\r\n          headers: {\r\n            \"Content-Type\": \"application/json\",\r\n            Authorization: `Bearer ${localStorage.getItem(\"token\")}`\r\n          },\r\n          body: JSON.stringify({\r\n            examId,\r\n            verificationStatus: \"no_face\",\r\n            details: `No face detected during verification at ${new Date().toLocaleTimeString()}`\r\n          })\r\n        });\r\n        \r\n        return;\r\n      }\r\n      \r\n      // Calculate average distance for more stable verification\r\n      let totalDistance = 0;\r\n      let bestDistance = Infinity;\r\n      \r\n      validDetections.forEach(detection => {\r\n        const distance = faceapi.euclideanDistance(registeredDescriptor, detection.descriptor);\r\n        totalDistance += distance;\r\n        if (distance < bestDistance) {\r\n          bestDistance = distance;\r\n        }\r\n      });\r\n      \r\n      const avgDistance = totalDistance / validDetections.length;\r\n      const similarity = Math.max(0, (1 - avgDistance) * 100);\r\n      \r\n      // Stricter threshold for continuous verification\r\n      const VERIFICATION_THRESHOLD = 0.45;\r\n      const isMatch = avgDistance < VERIFICATION_THRESHOLD;\r\n\r\n      console.log(`ðŸ” Verification: Detections=${validDetections.length}/${attempts}, AvgDistance=${avgDistance.toFixed(3)}, BestDistance=${bestDistance.toFixed(3)}, Similarity=${similarity.toFixed(1)}%, Match=${isMatch}`);\r\n\r\n      if (isMatch) {\r\n        setFaceVerificationStatus(\"verified\");\r\n        setVerificationFailures(0);\r\n        \r\n        // Only log successful verifications occasionally to avoid cluttering the log\r\n        if (Math.random() < 0.3) {\r\n          setLogs(prev => [...prev, `âœ… Identity verified at ${new Date().toLocaleTimeString()} (${similarity.toFixed(1)}%)`]);\r\n        }\r\n        \r\n        // Log to backend (less frequently)\r\n        if (Math.random() < 0.2) {\r\n          await fetch(\"http://localhost:4000/api/exam/verify-face\", {\r\n            method: \"POST\",\r\n            headers: {\r\n              \"Content-Type\": \"application/json\",\r\n              Authorization: `Bearer ${localStorage.getItem(\"token\")}`\r\n            },\r\n            body: JSON.stringify({\r\n              examId,\r\n              verificationStatus: \"verified\",\r\n              confidence: similarity,\r\n              details: `Identity verified for ${user.name}`\r\n            })\r\n          });\r\n        }\r\n      } else {\r\n        const newCount = verificationFailures + 1;\r\n        setVerificationFailures(newCount);\r\n        setFaceVerificationStatus(\"failed\");\r\n        \r\n        setLogs(prev => [...prev, `âŒ Identity mismatch at ${new Date().toLocaleTimeString()} (${similarity.toFixed(1)}%) - Attempt ${newCount}/3`]);\r\n        \r\n        // Log the identity verification failure (no alert message)\r\n        // The failure will be recorded in proctoring logs for admin review\r\n        \r\n        // Log to backend\r\n        await fetch(\"http://localhost:4000/api/exam/verify-face\", {\r\n          method: \"POST\",\r\n          headers: {\r\n            \"Content-Type\": \"application/json\",\r\n            Authorization: `Bearer ${localStorage.getItem(\"token\")}`\r\n          },\r\n          body: JSON.stringify({\r\n            examId,\r\n            verificationStatus: \"failed\",\r\n            confidence: similarity,\r\n            details: `Identity mismatch detected - Expected: ${user.name}, Attempt: ${newCount}/3`\r\n          })\r\n        });\r\n\r\n        if (newCount >= 3) {\r\n          // Auto-submit without alert message\r\n          // Maximum verification failures reached, exam will be auto-submitted\r\n          handleSubmit();\r\n        }\r\n      }\r\n\r\n      setLastVerificationTime(currentTime);\r\n    } catch (error) {\r\n      console.error(\"Verification error:\", error);\r\n      setLogs(prev => [...prev, `âš ï¸ Verification error at ${new Date().toLocaleTimeString()}`]);\r\n    }\r\n  };\r\n\r\n  // Tab switching detection with duration tracking\r\n  useEffect(() => {\r\n    let tabSwitchStartTime = null;\r\n    \r\n    const handleVisibilityChange = () => {\r\n      if (!timerStarted) return;\r\n      \r\n      if (document.hidden) {\r\n        // Tab switched away\r\n        tabSwitchStartTime = new Date();\r\n      } else if (tabSwitchStartTime) {\r\n        // Tab switched back\r\n        const endTime = new Date();\r\n        const duration = Math.round((endTime - tabSwitchStartTime) / 1000);\r\n        const newCount = tabSwitchCount + 1;\r\n        \r\n        setTabSwitchCount(newCount);\r\n        setLogs(prev => [...prev, `âš ï¸ Tab switch #${newCount} at ${tabSwitchStartTime ? tabSwitchStartTime.toLocaleTimeString() : new Date().toLocaleTimeString()} (Duration: ${duration}s)`]);\r\n        \r\n        // Log to backend\r\n        try {\r\n          const token = localStorage.getItem(\"token\");\r\n          fetch(\"http://localhost:4000/api/exam/log-violation\", {\r\n            method: \"POST\",\r\n            headers: {\r\n              \"Content-Type\": \"application/json\",\r\n              Authorization: `Bearer ${token}`\r\n            },\r\n            body: JSON.stringify({\r\n              examId,\r\n              violationType: \"tab_switch\",\r\n              details: `Tab switch #${newCount} (Duration: ${duration}s)`,\r\n              timestamp: new Date().toISOString()\r\n            })\r\n          });\r\n        } catch (error) {\r\n          console.error(\"Error logging tab switch:\", error);\r\n        }\r\n        \r\n        tabSwitchStartTime = null;\r\n      }\r\n    };\r\n    \r\n    document.addEventListener(\"visibilitychange\", handleVisibilityChange);\r\n    return () => document.removeEventListener(\"visibilitychange\", handleVisibilityChange);\r\n  }, [tabSwitchCount, timerStarted, examId]);\r\n\r\n  // Tab warning logic (without alert messages)\r\n  useEffect(() => {\r\n    if (tabSwitchCount === 1 && !warningShown) {\r\n      // First tab switch - log without alert\r\n      setWarningShown(true);\r\n    } else if (tabSwitchCount === 2) {\r\n      // Second tab switch - log without alert\r\n    } else if (tabSwitchCount >= 3) {\r\n      // Too many tab switches - auto-submit without alert\r\n      \r\n      // Log critical violation\r\n      try {\r\n        const token = localStorage.getItem(\"token\");\r\n        fetch(\"http://localhost:4000/api/exam/log-violation\", {\r\n          method: \"POST\",\r\n          headers: {\r\n            \"Content-Type\": \"application/json\",\r\n            Authorization: `Bearer ${token}`\r\n          },\r\n          body: JSON.stringify({\r\n            examId,\r\n            violationType: \"critical_tab_switch\",\r\n            details: `Critical violation: ${tabSwitchCount} tab switches detected. Auto-submitting exam.`,\r\n            timestamp: new Date().toISOString(),\r\n            severity: \"critical\"\r\n          })\r\n        });\r\n      } catch (error) {\r\n        console.error(\"Error logging critical violation:\", error);\r\n      }\r\n      \r\n      handleSubmit();\r\n    }\r\n  }, [tabSwitchCount, warningShown, examId]);\r\n\r\n  // Enhanced multiple face detection with violation logging\r\n  useEffect(() => {\r\n    if (!paper || !timerStarted) return;\r\n    \r\n    const VIOLATION_THRESHOLD = 3; // Auto-submit after 3 violations\r\n    \r\n    const interval = setInterval(async () => {\r\n      if (!videoRef.current) return;\r\n      // Check if video is ready for processing\r\n      if (!videoRef.current.readyState || videoRef.current.readyState < 2) {\r\n        console.log(\"Video not ready for multiple face detection, skipping check\");\r\n        return;\r\n      }\r\n      \r\n      try {\r\n        const detections = await faceapi.detectAllFaces(\r\n          videoRef.current,\r\n          new faceapi.TinyFaceDetectorOptions({\r\n            scoreThreshold: 0.6 // Higher threshold for more accurate detection\r\n          })\r\n        );\r\n        \r\n        if (detections.length > 1) {\r\n          if (!multipleFaceActive.current) {\r\n            multipleFaceActive.current = true;\r\n            startTimeRef.current = new Date();\r\n            \r\n            // Increment violation count\r\n            multipleFaceViolationCount.current++;\r\n            \r\n            // Log to UI\r\n            setLogs(prev => [...prev, `ðŸ‘¥ VIOLATION: Multiple faces detected (${detections.length} people) at ${startTimeRef.current ? startTimeRef.current.toLocaleTimeString() : new Date().toLocaleTimeString()} - #${multipleFaceViolationCount.current}`]);\r\n            \r\n            // Log to backend\r\n            try {\r\n              const token = localStorage.getItem(\"token\");\r\n              fetch(\"http://localhost:4000/api/exam/log-violation\", {\r\n                method: \"POST\",\r\n                headers: {\r\n                  \"Content-Type\": \"application/json\",\r\n                  Authorization: `Bearer ${token}`\r\n                },\r\n                body: JSON.stringify({\r\n                  examId,\r\n                  violationType: \"multiple_faces\",\r\n                  details: `Multiple faces detected (${detections.length} people)`,\r\n                  timestamp: new Date().toISOString(),\r\n                  faceCount: detections.length,\r\n                  violationNumber: multipleFaceViolationCount.current\r\n                })\r\n              });\r\n            } catch (error) {\r\n              console.error(\"Error logging multiple face violation:\", error);\r\n            }\r\n            \r\n            // Log violation without alert message\r\n            // Multiple face detection will be recorded in proctoring logs for admin review\r\n            \r\n            // Auto-submit if threshold reached (without alert)\r\n            if (multipleFaceViolationCount.current >= VIOLATION_THRESHOLD) {\r\n              // Maximum violations reached, auto-submit exam\r\n              handleSubmit();\r\n            }\r\n          }\r\n        } else if (multipleFaceActive.current) {\r\n          multipleFaceActive.current = false;\r\n          const endTime = new Date();\r\n          const duration = Math.round((endTime - startTimeRef.current) / 1000);\r\n          setLogs(prev => [...prev, `âœ… Multiple faces cleared at ${endTime.toLocaleTimeString()} (Duration: ${duration}s)`]);\r\n          \r\n          // Log resolution to backend\r\n          try {\r\n            const token = localStorage.getItem(\"token\");\r\n            fetch(\"http://localhost:4000/api/exam/log-violation\", {\r\n              method: \"POST\",\r\n              headers: {\r\n                \"Content-Type\": \"application/json\",\r\n                Authorization: `Bearer ${token}`\r\n              },\r\n              body: JSON.stringify({\r\n                examId,\r\n                violationType: \"multiple_faces_resolved\",\r\n                details: `Multiple faces violation resolved after ${duration} seconds`,\r\n                timestamp: new Date().toISOString(),\r\n                duration: duration\r\n              })\r\n            });\r\n          } catch (error) {\r\n            console.error(\"Error logging violation resolution:\", error);\r\n          }\r\n        }\r\n      } catch (err) {\r\n        console.error(\"Face detection error:\", err);\r\n      }\r\n    }, 3000);\r\n\r\n    return () => clearInterval(interval);\r\n  }, [paper, timerStarted, examId]);\r\n\r\n  // Define formatTime and handleSubmit before they're used\r\n  const formatTime = (seconds) => {\r\n    if (seconds === null) return \"Loading...\";\r\n    const min = Math.floor(seconds / 60);\r\n    const sec = seconds % 60;\r\n    return `${min}:${sec < 10 ? \"0\" : \"\"}${sec}`;\r\n  };\r\n\r\n  const handleAnswerChange = (index, value) => {\r\n    const newAnswers = [...answers];\r\n    newAnswers[index] = value;\r\n    setAnswers(newAnswers);\r\n  };\r\n\r\n  // Submit handler\r\n    const handleSubmit = async () => {\r\n    if (isSubmitting.current) return;\r\n    if (!paper) return alert(\"Exam not loaded!\");\r\n\r\n    const isAutoSubmit = tabSwitchCount >= 3 || timeLeft <= 0 || verificationFailures >= 3;\r\n\r\n    if (!isAutoSubmit) {\r\n      if (!window.confirm(\r\n        `Are you sure you want to submit?\\n\\n` +\r\n        `Time Remaining: ${formatTime(timeLeft)}\\n` +\r\n        `Questions Answered: ${answers.filter(a => a !== null).length}/${answers.length}\\n\\n` +\r\n        `You cannot change your answers after submission.`\r\n      )) {\r\n        return;\r\n      }\r\n    }\r\n\r\n    isSubmitting.current = true;\r\n\r\n    try {\r\n      console.log(\"Submitting exam answers:\", {\r\n        examId,\r\n        answersCount: answers.length,\r\n        tabSwitches: tabSwitchCount,\r\n        verificationFailures\r\n      });\r\n      \r\n      const token = localStorage.getItem(\"token\");\r\n      if (!token) {\r\n        throw new Error(\"Authentication token not found\");\r\n      }\r\n      \r\n      const response = await fetch(\"http://localhost:4000/api/exam/submit\", {\r\n        method: \"POST\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\",\r\n          Authorization: `Bearer ${token}`,\r\n        },\r\n        body: JSON.stringify({\r\n          userId: user?._id,\r\n          examId,\r\n          answers,\r\n          tabSwitches: [{\r\n            timestamp: new Date().toISOString(),\r\n            timeInExam: formatTime(paper.durationMins * 60 - timeLeft),\r\n            warningMessage: `${tabSwitchCount} tab switches detected during exam`\r\n          }],\r\n          verificationFailures,\r\n          timeSpent: examStartTime.current ? Math.floor((Date.now() - examStartTime.current) / 1000) : null\r\n        }),\r\n      });\r\n\r\n      const responseText = await response.text();\r\n      console.log(\"Submit response:\", response.status, responseText);\r\n      \r\n      if (!response.ok) {\r\n        throw new Error(`Submit failed: ${response.status} - ${responseText}`);\r\n      }\r\n      \r\n      let data;\r\n      try {\r\n        data = JSON.parse(responseText);\r\n      } catch (e) {\r\n        throw new Error(`Invalid JSON response: ${responseText}`);\r\n      }\r\n\r\n      if (data.submissionId) {\r\n        console.log(\"Submission successful, ID:\", data.submissionId);\r\n        stopCamera();\r\n        navigate(`/result/${data.submissionId}`);\r\n      } else {\r\n        throw new Error(\"No submission ID returned in response\");\r\n      }\r\n    } catch (err) {\r\n      console.error(\"Submit error:\", err);\r\n      alert(`âŒ Failed to submit exam: ${err.message}. Please try again.`);\r\n      isSubmitting.current = false;\r\n    }\r\n  };\r\n\r\n  \r\n\r\n \r\n\r\n  if (!paper || !paper.questions) {\r\n    return (\r\n      <div className=\"exam-loading\">\r\n        <div className=\"loading-spinner\"></div>\r\n        <h3>Loading exam...</h3>\r\n        <p>Please wait while we prepare your exam environment...</p>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  const question = paper.questions[currentQ];\r\n\r\n  return (\r\n    <div className=\"exam-page\">\r\n      <div className=\"theme-toggle-container\">\r\n        <ThemeToggle />\r\n      </div>\r\n      {/* Timer Status Banner */}\r\n      <div className={`timer-status-banner ${timerStarted ? 'active' : 'waiting'}`}>\r\n        {timerStarted ? (\r\n          <>\r\n            â±ï¸ <strong>Timer Started:</strong> Exam in progress\r\n          </>\r\n        ) : (\r\n          <>\r\n            â³ <strong>Initializing:</strong> Timer will start when camera is ready...\r\n          </>\r\n        )}\r\n      </div>\r\n\r\n      {/* Verification Status Banner */}\r\n      <div className={`verification-banner ${faceVerificationStatus}`}>\r\n        <div className=\"verification-content\">\r\n          {faceVerificationStatus === \"verified\" && (\r\n            <>\r\n              âœ… <strong>Identity Verified:</strong> {user.name}\r\n            </>\r\n          )}\r\n          {faceVerificationStatus === \"failed\" && (\r\n            <>\r\n              âŒ <strong>Verification Failed:</strong> {verificationFailures}/3 attempts\r\n            </>\r\n          )}\r\n          {faceVerificationStatus === \"warning\" && (\r\n            <>\r\n              âš ï¸ <strong>Warning:</strong> Face not detected\r\n            </>\r\n          )}\r\n          {faceVerificationStatus === \"loading\" && (\r\n            <>\r\n              ðŸ”„ <strong>Loading:</strong> Preparing verification system...\r\n            </>\r\n          )}\r\n          {faceVerificationStatus === \"ready\" && (\r\n            <>\r\n              ðŸŸ¢ <strong>Ready:</strong> Verification system active\r\n            </>\r\n          )}\r\n        </div>\r\n      </div>\r\n      \r\n      {/* Proctoring Violations Summary */}\r\n      <div className=\"proctoring-violations-summary\">\r\n        <div className=\"violation-metric\">\r\n          <span className=\"violation-label\">Identity Verification:</span>\r\n          <span className={`violation-value ${verificationFailures > 0 ? 'warning' : 'good'}`}>\r\n            {verificationFailures > 0 ? `${verificationFailures}/3 Failures` : 'Good'}\r\n          </span>\r\n        </div>\r\n        <div className=\"violation-metric\">\r\n          <span className=\"violation-label\">Tab Switching:</span>\r\n          <span className={`violation-value ${tabSwitchCount > 0 ? 'warning' : 'good'}`}>\r\n            {tabSwitchCount > 0 ? `${tabSwitchCount}/3 Switches` : 'None'}\r\n          </span>\r\n        </div>\r\n        <div className=\"violation-metric\">\r\n          <span className=\"violation-label\">Multiple Faces:</span>\r\n          <span className={`violation-value ${multipleFaceActive.current ? 'critical' : 'good'}`}>\r\n            {multipleFaceActive.current ? 'DETECTED!' : 'None'}\r\n          </span>\r\n        </div>\r\n        <div className=\"logs-container\">\r\n          <h4>Proctoring Logs</h4>\r\n          <div className=\"logs\">\r\n            {logs.slice(-8).reverse().map((log, index) => (\r\n              <div key={index} className={`log-entry ${log.includes(\"VIOLATION\") ? \"violation-log\" : log.includes(\"âš ï¸\") ? \"warning-log\" : log.includes(\"âœ…\") ? \"success-log\" : \"\"}`}>{log}</div>\r\n            ))}\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      <button\r\n        onClick={() => {\r\n          if (window.confirm(\"Exit exam? Your progress will be lost!\")) {\r\n            stopCamera();\r\n            navigate(\"/student/dashboard\");\r\n          }\r\n        }}\r\n        className=\"exam-back-btn\"\r\n      >\r\n        â† Exit Exam\r\n      </button>\r\n\r\n      <div className=\"exam-header\">\r\n        <div>\r\n          <h2>{paper.title}</h2>\r\n          <p>Student: <strong>{user.name}</strong></p>\r\n        </div>\r\n        <div className=\"timer\">\r\n          {timerStarted ? (\r\n            <>â±ï¸ Time: {formatTime(timeLeft)}</>\r\n          ) : (\r\n            <>â³ Starting...</>\r\n          )}\r\n        </div>\r\n      </div>\r\n\r\n      {tabSwitchCount > 0 && (\r\n        <div className=\"exam-tab-warning\">\r\n          âš ï¸ <strong>Tab Switches Detected: {tabSwitchCount}/3</strong>\r\n          {tabSwitchCount >= 2 && \" - One more will auto-submit!\"}\r\n        </div>\r\n      )}\r\n\r\n      <div className=\"exam-body\">\r\n        <div className=\"exam-main-content\">\r\n          <div className=\"exam-progress\">\r\n            Question {currentQ + 1} of {paper.questions.length}\r\n          </div>\r\n\r\n          <div className=\"exam-question\">\r\n            <h3>Q{currentQ + 1}: {question.text}</h3>\r\n            {question.imageUrl && (\r\n              <div className=\"exam-question-image\">\r\n                <img \r\n                  src={question.imageUrl} \r\n                  alt=\"Question\" \r\n                  onError={(e) => {\r\n                    console.log(\"Image failed to load:\", question.imageUrl);\r\n                    e.target.onerror = null;\r\n                    e.target.src = \"https://via.placeholder.com/400x200?text=Image+Not+Available\";\r\n                  }}\r\n                />\r\n              </div>\r\n            )}\r\n            {console.log(\"Question data:\", question)}\r\n            <div className=\"exam-options\">\r\n              {question.options.map((opt, idx) => (\r\n                <label\r\n                  key={idx}\r\n                  className={`exam-option-label ${answers[currentQ] === opt ? \"selected\" : \"\"}`}\r\n                >\r\n                  <input\r\n                    type=\"radio\"\r\n                    name={`q${currentQ}`}\r\n                    checked={answers[currentQ] === opt}\r\n                    onChange={() => handleAnswerChange(currentQ, opt)}\r\n                  />\r\n                  {opt}\r\n                </label>\r\n              ))}\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"exam-nav-buttons\">\r\n            {currentQ > 0 && (\r\n              <button onClick={() => setCurrentQ(currentQ - 1)} className=\"exam-prev-btn\">\r\n                â¬…ï¸ Previous\r\n              </button>\r\n            )}\r\n            {currentQ < paper.questions.length - 1 ? (\r\n              <button onClick={() => setCurrentQ(currentQ + 1)} className=\"exam-next-btn\">\r\n                Next âž¡ï¸\r\n              </button>\r\n            ) : (\r\n              <button onClick={handleSubmit} className=\"exam-submit-btn\" disabled={isSubmitting.current}>\r\n                {isSubmitting.current ? \"â³ Submitting...\" : \"ðŸš€ Submit Exam\"}\r\n              </button>\r\n            )}\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"exam-sidebar\">\r\n          <div className=\"exam-camera-preview\">\r\n            <h4>ðŸ“· Live Monitoring</h4>\r\n            <video ref={videoRef} autoPlay muted playsInline style={{ width: \"100%\", maxWidth: \"300px\", borderRadius: \"12px\" }} />\r\n            <div className=\"verification-status\">\r\n              {faceVerificationStatus === \"verified\" && (\r\n                <span className=\"status-verified\">âœ… Verified</span>\r\n              )}\r\n              {faceVerificationStatus === \"failed\" && (\r\n                <span className=\"status-warning\">âŒ Failed ({verificationFailures}/3)</span>\r\n              )}\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"exam-face-logs\">\r\n            <h4>ðŸ“‹ Activity Log</h4>\r\n            {logs.length > 0 ? (\r\n              <ul>\r\n                {logs.slice(-10).reverse().map((log, i) => (\r\n                  <li key={i}>{log}</li>\r\n                ))}\r\n              </ul>\r\n            ) : (\r\n              <p>âœ… No issues detected</p>\r\n            )}\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}